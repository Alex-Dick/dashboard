<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Home Dashboard</title>
  <style>
    /* Grund-Setup */
    html, body { 
      height: 100%; margin: 0; padding: 0; 
      font-family: -apple-system, sans-serif; 
      background-color: transparent !important; 
      color: #fff; overflow: hidden; 
    }

    .bg-fixed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; object-fit: cover; }
    .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); z-index: -5; }

    .wrap { 
      position: relative; z-index: 1; width: 100%; height: 100vh; 
      display: flex; align-items: center; justify-content: space-between;
      padding: 25px; box-sizing: border-box;
    }

    /* Container */
    .left { width: 34%; height: 620px; }
    .right { 
      width: 63%; height: 620px; 
      background: rgba(15, 23, 42, 0.45); 
      border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); 
      display: flex; flex-direction: column; overflow: hidden;
    }

    .panel { 
      background: rgba(15, 23, 42, 0.45); border-radius: 25px; height: 100%; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 1px solid rgba(255,255,255,0.2); box-sizing: border-box;
    }

    .time { font-size: 8vw; font-weight: bold; line-height: 1.1; text-shadow: 0 2px 12px rgba(0,0,0,0.8); }
    .date-line { font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }

    /* Header Navigation */
    .calendar-header { 
      padding: 10px 20px; background: rgba(255,255,255,0.1); 
      display: flex; align-items: center; justify-content: space-between; height: 70px; box-sizing: border-box;
    }
    .header-center { font-weight: bold; font-size: 1.6rem; flex-grow: 1; text-align: center; }
    .nav-btns { display: flex; gap: 5px; }
    
    .icon-btn { 
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; 
      width: 50px; height: 45px; border-radius: 10px; font-size: 1.2rem; cursor: pointer;
    }
    .icon-btn.active { background: #3b82f6; border-color: #60a5fa; }

    /* Grid Bereich */
    #calendarGrid { flex-grow: 1; overflow-y: auto; position: relative; }

    /* --- MONATSANSICHT STYLES --- */
    .month-table { display: grid; grid-template-columns: 40px repeat(7, 1fr); height: 100%; }
    .month-cell { border: 0.5px solid rgba(255,255,255,0.1); padding: 4px; min-height: 80px; background: rgba(255,255,255,0.03); }
    
    /* KW Spalte Anpassung: Komplett Transparent */
    .month-head { text-align: center; font-weight: bold; font-size: 0.8rem; opacity: 0.7; height: 30px; display: flex; align-items: center; justify-content: center; background: transparent !important; border: none !important; }
    .kw-cell { display: flex; align-items: center; justify-content: center; color: #3b82f6; font-size: 0.75rem; font-weight: bold; background: transparent !important; border-left: none !important; border-bottom: none !important; border-top: none !important; }

    .day-n { font-weight: bold; font-size: 1rem; }
    .m-event { background: #f97316; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; }

    /* --- WOCHENANSICHT STYLES --- */
    .week-container { display: flex; position: relative; height: 1000px; padding-top: 40px; }
    .week-header-row { position: absolute; top: 0; left: 50px; right: 0; display: flex; height: 40px; }
    .week-head-day { flex: 1; text-align: center; font-size: 0.8rem; font-weight: bold; border-left: 1px solid rgba(255,255,255,0.1); }
    
    .time-sidebar { width: 50px; flex-shrink: 0; border-right: 1px solid rgba(255,255,255,0.2); }
    .hour-label { height: 60px; font-size: 0.7rem; text-align: right; padding-right: 5px; opacity: 0.5; }
    
    .day-col { flex: 1; position: relative; border-right: 1px solid rgba(255,255,255,0.1); }
    .event-card { 
      position: absolute; left: 2px; right: 2px; background: rgba(249, 115, 22, 0.9); 
      border-radius: 4px; border-left: 3px solid #ea580c; padding: 3px; font-size: 0.7rem; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3); overflow: hidden;
    }

    .today-bg { background: rgba(59, 130, 246, 0.15) !important; }
  </style>
</head>
<body>

  <img src="Winter_1.jpg" class="bg-fixed">
  <div class="bg-overlay"></div>

  <div class="wrap">
    <div class="left">
      <div class="panel">
        <div id="dateLine" class="date-line">-</div>
        <div id="hoursMinutes" class="time">00:00</div>
      </div>
    </div>
    
    <div class="right">
      <div class="calendar-header">
        <div class="nav-btns">
          <button class="icon-btn" id="prevBtn">&#10094;</button>
          <button class="icon-btn" id="nextBtn">&#10095;</button>
          <button class="icon-btn" id="todayBtn">&#8634;</button>
        </div>
        <div id="calendarLabel" class="header-center">-</div>
        <div class="nav-btns">
          <button class="icon-btn active" id="viewMonth">田</button>
          <button class="icon-btn" id="viewWeek">◷</button>
        </div>
      </div>
      
      <div id="calendarGrid"></div>
    </div>
  </div>

  <script>
    var calendarEvents = {}, viewDate = new Date(), currentView = 'month';

    function updateClock(){
      var now = new Date(), d = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
      document.getElementById('hoursMinutes').textContent = (now.getHours()<10?'0':'')+now.getHours()+':'+(now.getMinutes()<10?'0':'')+now.getMinutes();
      document.getElementById('dateLine').textContent = d[now.getDay()] + ', ' + now.getDate() + '.' + (now.getMonth() + 1) + '.';
    }
    setInterval(updateClock, 1000); updateClock();

    function getKW(d) {
      var date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
      return Math.ceil((((date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
    }

    function renderCalendar(){
      var container = document.getElementById('calendarGrid');
      container.innerHTML = '';
      var today = new Date();

      if(currentView === 'month') {
        renderMonthView(container, today);
      } else {
        renderWeekView(container, today);
      }
    }

    function renderMonthView(container, today) {
      var y = viewDate.getFullYear(), m = viewDate.getMonth();
      var months = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      document.getElementById('calendarLabel').textContent = months[m] + ' ' + y;

      var grid = document.createElement('div'); grid.className = 'month-table';
      ['KW','Mo','Di','Mi','Do','Fr','Sa','So'].forEach(h => {
        var c = document.createElement('div'); c.className = 'month-cell month-head'; c.textContent = h; grid.appendChild(c);
      });

      var first = new Date(y, m, 1).getDay(); first = (first === 0) ? 6 : first - 1;
      var last = new Date(y, m + 1, 0).getDate();
      var dayCounter = 1 - first;

      for(var w=0; w<6; w++) {
        var kw = document.createElement('div'); kw.className = 'month-cell kw-cell';
        kw.textContent = getKW(new Date(y, m, dayCounter + (dayCounter < 1 ? first : 0)));
        grid.appendChild(kw);

        for(var d=0; d<7; d++) {
          var cell = document.createElement('div'); cell.className = 'month-cell';
          if(dayCounter > 0 && dayCounter <= last) {
            if(dayCounter===today.getDate() && m===today.getMonth() && y===today.getFullYear()) cell.classList.add('today-bg');
            cell.innerHTML = `<div class="day-n">${dayCounter}</div>`;
            var key = y+'-'+m+'-'+dayCounter;
            if(calendarEvents[key]) calendarEvents[key].forEach(ev => {
              cell.innerHTML += `<div class="m-event">${ev.t}</div>`;
            });
          }
          grid.appendChild(cell);
          dayCounter++;
        }
        if(dayCounter > last) break;
      }
      container.appendChild(grid);
    }

    function renderWeekView(container, today) {
      var start = new Date(viewDate);
      var day = start.getDay();
      start.setDate(start.getDate() - (day === 0 ? 6 : day - 1));
      document.getElementById('calendarLabel').textContent = "KW " + getKW(start);

      var weekWrapper = document.createElement('div'); weekWrapper.className = 'week-container';
      var headRow = document.createElement('div'); headRow.className = 'week-header-row';
      var daysNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
      var sidebar = document.createElement('div'); sidebar.className = 'time-sidebar';
      
      for(var h=8; h<=22; h++) {
        var l = document.createElement('div'); l.className = 'hour-label'; l.textContent = h + ':00';
        sidebar.appendChild(l);
      }
      weekWrapper.appendChild(sidebar);

      for(var i=0; i<7; i++) {
        var curr = new Date(start); curr.setDate(start.getDate() + i);
        var hDay = document.createElement('div'); hDay.className = 'week-head-day';
        hDay.innerHTML = daysNames[i] + '<br>' + curr.getDate() + '.';
        headRow.appendChild(hDay);

        var col = document.createElement('div'); col.className = 'day-col';
        if(curr.toDateString() === today.toDateString()) col.classList.add('today-bg');
        
        var key = curr.getFullYear()+'-'+curr.getMonth()+'-'+curr.getDate();
        if(calendarEvents[key]) {
          calendarEvents[key].forEach(ev => {
            if(ev.h >= 8 && ev.h <= 22) {
              var card = document.createElement('div'); card.className = 'event-card';
              card.style.top = ((ev.h - 8) * 60 + ev.m) + 'px';
              card.style.height = '50px';
              card.innerHTML = `<b>${ev.time}</b><br>${ev.t}`;
              col.appendChild(card);
            }
          });
        }
        weekWrapper.appendChild(col);
      }
      weekWrapper.appendChild(headRow);
      container.appendChild(weekWrapper);
    }

    function loadCal() {
      ['basic.ics', 'calendar2.ics', 'feiertage-deutschland.ics'].forEach(f => {
        fetch('calendars/' + f).then(r => r.text()).then(data => {
          var lines = data.split('\n');
          for(var i=0; i<lines.length; i++) {
            if(lines[i].includes('BEGIN:VEVENT')) {
              var ev = {h:8, m:0, time:''}, j = i;
              while(lines[j] && !lines[j].includes('END:VEVENT')){
                if(lines[j].includes('DTSTART')){
                  var v = lines[j].split(':')[1]?.trim();
                  if(v){
                    ev.d = new Date(v.substring(0,4), parseInt(v.substring(4,6))-1, parseInt(v.substring(6,8)));
                    if(v.includes('T')){
                      ev.h = parseInt(v.substring(9,11));
                      ev.m = parseInt(v.substring(11,13));
                      ev.time = ev.h + ":" + (ev.m < 10 ? '0' : '') + ev.m;
                    }
                  }
                }
                if(lines[j].includes('SUMMARY')) ev.t = lines[j].split(':')[1]?.replace(/\\/g,"").trim();
                j++;
              }
              if(ev.d){
                var k = ev.d.getFullYear()+'-'+ev.d.getMonth()+'-'+ev.d.getDate();
                if(!calendarEvents[k]) calendarEvents[k]=[]; calendarEvents[k].push(ev);
              }
              i = j;
            }
          }
          renderCalendar();
        }).catch(e => console.log("Fehler beim Laden von " + f));
      });
    }

    document.getElementById('prevBtn').onclick = () => { if(currentView==='month') viewDate.setMonth(viewDate.getMonth()-1); else viewDate.setDate(viewDate.getDate()-7); renderCalendar(); };
    document.getElementById('nextBtn').onclick = () => { if(currentView==='month') viewDate.setMonth(viewDate.getMonth()+1); else viewDate.setDate(viewDate.getDate()+7); renderCalendar(); };
    document.getElementById('todayBtn').onclick = () => { viewDate = new Date(); renderCalendar(); };
    document.getElementById('viewMonth').onclick = function(){ currentView = 'month'; this.classList.add('active'); document.getElementById('viewWeek').classList.remove('active'); renderCalendar(); };
    document.getElementById('viewWeek').onclick = function(){ currentView = 'week'; this.classList.add('active'); document.getElementById('viewMonth').classList.remove('active'); renderCalendar(); };
    
    loadCal(); renderCalendar();
  </script>
</body>
</html>
