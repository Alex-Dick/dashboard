<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Home Dashboard</title>
  <style>
    :root {
      --bg-panel: rgba(15, 23, 42, 0.6);
      --text-main: #ffffff;
      --accent: #3b82f6;
    }

    body.night-mode {
      --bg-panel: rgba(0, 0, 0, 0.9);
      --text-main: #555;
      --accent: #800;
    }

    /* Absolute Basis-Resets für iPad Safari */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html, body { 
      height: 100%; width: 100%; margin: 0; padding: 0; 
      font-family: -apple-system, sans-serif; 
      background-color: #000; color: var(--text-main); 
      overflow: hidden; position: fixed; /* Verhindert Bouncing */
    }

    /* Hintergrund fixen */
    .bg-fixed { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      z-index: -10; object-fit: cover; transition: opacity 1.5s;
    }
    body.night-mode .bg-fixed { opacity: 0; }

    /* Layout-Container auf feste Maße für iPad */
    .wrap { 
      display: flex; width: 100vw; height: 100vh; 
      padding: 20px; align-items: stretch; justify-content: space-between;
    }

    .left { width: 33%; display: flex; flex-direction: column; }
    .right { 
      width: 64%; background: var(--bg-panel); 
      border-radius: 20px; border: 1px solid rgba(255,255,255,0.15); 
      display: flex; flex-direction: column; overflow: hidden;
    }

    .panel { 
      background: var(--bg-panel); border-radius: 20px; flex-grow: 1;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .time { font-size: 80px; font-weight: bold; }
    .date-line { font-size: 24px; margin-bottom: 5px; opacity: 0.8; }

    .night-toggle {
      position: absolute; top: 15px; right: 15px; z-index: 100;
      background: rgba(255,255,255,0.15); border: none; color: white;
      width: 44px; height: 44px; border-radius: 50%; font-size: 20px;
    }

    /* Kalender Header fixen */
    .calendar-header { 
      padding: 10px; background: rgba(255,255,255,0.05); 
      display: flex; align-items: center; justify-content: space-between;
    }
    
    .icon-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
      color: var(--text-main); padding: 8px 12px; border-radius: 8px; margin: 0 2px;
    }
    .icon-btn.active { background: var(--accent); color: white; }

    #calendarGrid { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* Monatstabelle */
    .month-table { display: grid; grid-template-columns: 35px repeat(7, 1fr); width: 100%; }
    .month-cell { border: 0.5px solid rgba(255,255,255,0.08); min-height: 80px; padding: 4px; overflow: hidden; }
    .month-head { font-weight: bold; font-size: 12px; height: 30px; display: flex; align-items: center; justify-content: center; opacity: 0.5; }
    .kw-cell { font-size: 10px; color: var(--accent); display: flex; align-items: center; justify-content: center; opacity: 0.4; }
    .day-n { font-weight: bold; font-size: 14px; margin-bottom: 2px; }

    .m-event { 
      font-size: 10px; padding: 2px 4px; margin-bottom: 2px; 
      border-left: 3px solid; border-radius: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: white !important; /* Text immer weiß für Lesbarkeit */
    }

    .other-month { opacity: 0.2; }
    .today-bg { background: rgba(59, 130, 246, 0.2) !important; }
  </style>
</head>
<body>

  <img src="Winter_1.jpg" class="bg-fixed" onerror="this.style.display='none'">
  
  <button class="night-toggle" id="nightBtn">☾</button>

  <div class="wrap">
    <div class="left">
      <div class="panel">
        <div id="dateLine" class="date-line">...</div>
        <div id="hoursMinutes" class="time">00:00</div>
      </div>
    </div>
    
    <div class="right">
      <div class="calendar-header">
        <div>
          <button class="icon-btn" id="prevBtn"> < </button>
          <button class="icon-btn" id="todayBtn"> heute </button>
          <button class="icon-btn" id="nextBtn"> > </button>
        </div>
        <div id="calendarLabel" style="font-weight:bold">Lade...</div>
        <div>
          <button class="icon-btn active" id="viewMonth">M</button>
          <button class="icon-btn" id="viewWeek">W</button>
        </div>
      </div>
      <div id="calendarGrid"></div>
    </div>
  </div>

  <script>
    // Polyfill für ältere Safari-Versionen (Array.from / Object.keys etc. sind meist okay, aber wir halten es simpel)
    var calendarEvents = {}, viewDate = new Date(), currentView = 'month';
    var fileColors = { 'basic.ics': '#3b82f6', 'calendar2.ics': '#f97316', 'feiertage-deutschland.ics': '#ef4444' };

    function updateClock(){
      var now = new Date();
      var days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
      var h = now.getHours(), m = now.getMinutes();
      document.getElementById('hoursMinutes').textContent = (h<10?'0':'')+h + ':' + (m<10?'0':'')+m;
      document.getElementById('dateLine').textContent = days[now.getDay()] + ', ' + now.getDate() + '.' + (now.getMonth() + 1) + '.';
      
      if (!window.manualNightMode) {
        if (h >= 22 || h < 6) document.body.classList.add('night-mode');
        else document.body.classList.remove('night-mode');
      }
    }
    setInterval(updateClock, 30000); updateClock();

    document.getElementById('nightBtn').onclick = function() {
      window.manualNightMode = true;
      document.body.classList.toggle('night-mode');
      this.textContent = document.body.classList.contains('night-mode') ? '☀' : '☾';
    };

    function getKW(d) {
      var date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil(( ( (date - yearStart) / 86400000) + 1)/7);
    }

    function renderCalendar(){
      var container = document.getElementById('calendarGrid');
      container.innerHTML = '';
      if(currentView === 'month') renderMonthView(container);
      else container.innerHTML = '<div style="padding:20px">Wochenansicht wird geladen...</div>'; 
    }

    function renderMonthView(container) {
      var y = viewDate.getFullYear(), m = viewDate.getMonth();
      var months = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      document.getElementById('calendarLabel').textContent = months[m] + ' ' + y;
      
      var grid = document.createElement('div'); grid.className = 'month-table';
      var headers = ['','Mo','Di','Mi','Do','Fr','Sa','So'];
      for(var i=0; i<headers.length; i++) {
        var h = document.createElement('div'); h.className = 'month-cell month-head'; h.textContent = headers[i]; grid.appendChild(h);
      }

      var first = new Date(y, m, 1);
      var startOffset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
      var curr = new Date(first); curr.setDate(curr.getDate() - startOffset);

      for(var row=0; row<6; row++) {
        var kw = document.createElement('div'); kw.className = 'month-cell kw-cell'; kw.textContent = getKW(curr); grid.appendChild(kw);
        for(var d=0; d<7; d++) {
          var cell = document.createElement('div'); cell.className = 'month-cell';
          if(curr.getMonth() !== m) cell.classList.add('other-month');
          if(curr.toDateString() === new Date().toDateString()) cell.classList.add('today-bg');
          
          cell.innerHTML = '<div class="day-n">' + curr.getDate() + '</div>';
          var key = curr.getFullYear()+'-'+curr.getMonth()+'-'+curr.getDate();
          if(calendarEvents[key]) {
            for(var e=0; e < calendarEvents[key].length; e++) {
              var ev = calendarEvents[key][e];
              var div = document.createElement('div'); div.className = 'm-event';
              div.style.borderLeftColor = ev.color;
              div.style.backgroundColor = ev.color + '44'; // Etwas mehr Deckkraft für ältere Screens
              div.textContent = ev.t;
              cell.appendChild(div);
            }
          }
          grid.appendChild(cell);
          curr.setDate(curr.getDate() + 1);
        }
        if(curr.getMonth() > m && curr.getFullYear() >= y) break;
      }
      container.appendChild(grid);
    }

    function loadCal() {
      // Wir simulieren hier den Erfolg, falls die Dateien fehlen, damit die UI nicht leer bleibt
      Object.keys(fileColors).forEach(function(f) {
        fetch('calendars/' + f).then(function(r) { return r.text(); }).then(function(data) {
          var lines = data.split('\n');
          for(var i=0; i<lines.length; i++) {
            if(lines[i].indexOf('BEGIN:VEVENT') !== -1) {
              var ev = {color: fileColors[f]}, j = i;
              while(lines[j] && lines[j].indexOf('END:VEVENT') === -1){
                if(lines[j].indexOf('DTSTART') !== -1) {
                  var v = lines[j].split(':')[1];
                  if(v) ev.d = new Date(v.substring(0,4), parseInt(v.substring(4,6))-1, parseInt(v.substring(6,8)));
                }
                if(lines[j].indexOf('SUMMARY') !== -1) ev.t = lines[j].split(':')[1].trim();
                j++;
              }
              if(ev.d){
                var k = ev.d.getFullYear()+'-'+ev.d.getMonth()+'-'+ev.d.getDate();
                if(!calendarEvents[k]) calendarEvents[k]=[]; 
                calendarEvents[k].push(ev);
              }
              i = j;
            }
          }
          renderCalendar();
        }).catch(function(e) { console.log("Fehler bei " + f); renderCalendar(); });
      });
    }

    document.getElementById('prevBtn').onclick = function() { viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); };
    document.getElementById('nextBtn').onclick = function() { viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); };
    document.getElementById('todayBtn').onclick = function() { viewDate = new Date(); renderCalendar(); };
    
    loadCal(); renderCalendar();
  </script>
</body>
</html>
