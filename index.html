<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Home Dashboard</title>
  <style>
    :root {
      --bg-panel: rgba(15, 23, 42, 0.5);
      --text-main: #ffffff;
      --accent: #3b82f6;
      --dim-opacity: 1;
    }

    /* NACHTMODUS CSS VARIABLEN */
    body.night-mode {
      --bg-panel: rgba(0, 0, 0, 0.9);
      --text-main: #444; /* Sehr dunkles Grau */
      --accent: #600;    /* Dunkles Rot, blendet nicht */
      --dim-opacity: 0.2;
    }

    html, body { 
      height: 100%; margin: 0; padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background-color: #000 !important; 
      color: var(--text-main); overflow: hidden; 
      transition: color 1s ease;
    }

    .bg-fixed { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; object-fit: cover; 
      transition: opacity 2s ease;
    }
    body.night-mode .bg-fixed { opacity: 0; } /* Hintergrund aus im Nachtmodus */

    .bg-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0, 0, 0, 0.2); z-index: -5; 
    }

    .wrap { 
      position: relative; z-index: 1; width: 100%; height: 100vh; 
      display: flex; align-items: center; justify-content: space-between;
      padding: 25px; box-sizing: border-box;
    }

    .left { width: 34%; height: 620px; }
    .right { 
      width: 63%; height: 620px; 
      background: var(--bg-panel); 
      border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); 
      display: flex; flex-direction: column; overflow: hidden;
      transition: background 1s ease;
    }

    .panel { 
      background: var(--bg-panel); border-radius: 25px; height: 100%; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box;
      transition: background 1s ease;
    }

    .time { font-size: 8vw; font-weight: bold; line-height: 1.1; text-shadow: 0 2px 12px rgba(0,0,0,0.5); }
    .date-line { font-size: 2rem; margin-bottom: 10px; }

    /* NACHTMODUS BUTTON */
    .night-toggle {
      position: absolute; top: 20px; right: 20px; z-index: 100;
      background: rgba(255,255,255,0.1); border: none; color: white;
      width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      opacity: 0.4; transition: opacity 0.3s;
    }
    .night-toggle:hover { opacity: 1; }

    .calendar-header { 
      padding: 10px 20px; background: rgba(255,255,255,0.05); 
      display: flex; align-items: center; justify-content: space-between; height: 70px;
    }
    
    .icon-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); 
      width: 50px; height: 45px; border-radius: 10px; cursor: pointer;
    }
    .icon-btn.active { background: var(--accent); color: #fff; }

    #calendarGrid { flex-grow: 1; overflow: hidden; opacity: var(--dim-opacity); transition: opacity 1s ease; }

    /* MONATSANSICHT */
    .month-table { display: grid; grid-template-columns: 40px repeat(7, 1fr); width: 100%; }
    .month-cell { border: 0.5px solid rgba(255,255,255,0.05); padding: 4px; height: 90px; overflow: hidden; }
    .month-head { text-align: center; font-weight: bold; font-size: 0.8rem; opacity: 0.5; height: 35px; display: flex; align-items: center; justify-content: center; border: none; }
    .kw-cell { display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 0.75rem; font-weight: bold; border: none; opacity: 0.4; }
    .day-n { font-weight: bold; font-size: 0.9rem; margin-bottom: 3px; }
    .other-month { opacity: 0.2; }

    .m-event { 
      font-size: 0.65rem; padding: 2px 4px 2px 6px; margin-top: 2px; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: var(--text-main); border-left: 3px solid transparent; border-radius: 2px;
    }

    /* WOCHENANSICHT */
    .week-container { display: flex; position: relative; height: 950px; padding-top: 40px; }
    .week-header-row { position: absolute; top: 0; left: 50px; right: 0; display: flex; height: 40px; }
    .week-head-day { flex: 1; text-align: center; font-size: 0.8rem; font-weight: bold; opacity: 0.7; }
    .time-sidebar { width: 50px; opacity: 0.3; font-size: 0.7rem; text-align: right; padding-right: 8px; }
    .hour-label { height: 60px; }
    .day-col { flex: 1; position: relative; border-right: 1px solid rgba(255,255,255,0.05); }
    .event-card { 
      position: absolute; left: 2px; right: 2px; border-radius: 4px; border-left: 4px solid transparent; 
      padding: 4px 6px; font-size: 0.7rem; color: var(--text-main); overflow: hidden;
    }

    .today-bg { background: rgba(59, 130, 246, 0.1) !important; }
    body.night-mode .today-bg { background: rgba(255, 0, 0, 0.05) !important; }
  </style>
</head>
<body class="">

  <img src="Winter_1.jpg" class="bg-fixed">
  <div class="bg-overlay"></div>

  <button class="night-toggle" id="nightBtn" title="Nachtmodus umschalten">☾</button>

  <div class="wrap">
    <div class="left">
      <div class="panel">
        <div id="dateLine" class="date-line">-</div>
        <div id="hoursMinutes" class="time">00:00</div>
      </div>
    </div>
    
    <div class="right">
      <div class="calendar-header">
        <div class="nav-btns">
          <button class="icon-btn" id="prevBtn">&#10094;</button>
          <button class="icon-btn" id="nextBtn">&#10095;</button>
          <button class="icon-btn" id="todayBtn">&#8634;</button>
        </div>
        <div id="calendarLabel" style="font-weight: bold; font-size: 1.4rem;">-</div>
        <div class="nav-btns">
          <button class="icon-btn active" id="viewMonth">田</button>
          <button class="icon-btn" id="viewWeek">◷</button>
        </div>
      </div>
      <div id="calendarGrid"></div>
    </div>
  </div>

  <script>
    var calendarEvents = {}, viewDate = new Date(), currentView = 'month';
    const fileColors = { 'basic.ics': '#3b82f6', 'calendar2.ics': '#f97316', 'feiertage-deutschland.ics': '#ef4444' };

    function updateClock(){
      var now = new Date(), d = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
      document.getElementById('hoursMinutes').textContent = (now.getHours()<10?'0':'')+now.getHours()+':'+(now.getMinutes()<10?'0':'')+now.getMinutes();
      document.getElementById('dateLine').textContent = d[now.getDay()] + ', ' + now.getDate() + '.' + (now.getMonth() + 1) + '.';
      
      // AUTO-NACHTMODUS LOGIK
      var hour = now.getHours();
      // Zwischen 22 und 6 Uhr automatisch einschalten (wenn nicht manuell umgestellt)
      if (!window.manualNightMode) {
        if (hour >= 22 || hour < 6) {
          document.body.classList.add('night-mode');
        } else {
          document.body.classList.remove('night-mode');
        }
      }
    }
    setInterval(updateClock, 1000); updateClock();

    // MANUELLER TOGGLE
    document.getElementById('nightBtn').onclick = () => {
      window.manualNightMode = true; // Stoppt die Automatik für diese Session
      document.body.classList.toggle('night-mode');
      var isNight = document.body.classList.contains('night-mode');
      document.getElementById('nightBtn').textContent = isNight ? '☀' : '☾';
    };

    function getKW(d) {
      var date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
      return Math.ceil((((date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
    }

    function renderCalendar(){
      var container = document.getElementById('calendarGrid');
      container.innerHTML = '';
      var today = new Date();
      if(currentView === 'month') renderMonthView(container, today);
      else renderWeekView(container, today);
    }

    function renderMonthView(container, today) {
      var y = viewDate.getFullYear(), m = viewDate.getMonth();
      var months = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      document.getElementById('calendarLabel').textContent = months[m] + ' ' + y;
      var grid = document.createElement('div'); grid.className = 'month-table';
      ['','Mo','Di','Mi','Do','Fr','Sa','So'].forEach(h => {
        var c = document.createElement('div'); c.className = 'month-cell month-head'; c.textContent = h; grid.appendChild(c);
      });
      var first = new Date(y, m, 1);
      var offset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
      var curr = new Date(first); curr.setDate(curr.getDate() - offset);
      while (curr.getMonth() <= m || curr.getDay() !== 1) {
        if (curr.getDay() === 1) {
          var kw = document.createElement('div'); kw.className = 'month-cell kw-cell'; kw.textContent = getKW(curr); grid.appendChild(kw);
        }
        var cell = document.createElement('div'); cell.className = 'month-cell';
        if (curr.getMonth() !== m) cell.classList.add('other-month');
        if (curr.toDateString() === today.toDateString()) cell.classList.add('today-bg');
        cell.innerHTML = `<div class="day-n">${curr.getDate()}</div>`;
        var key = curr.getFullYear()+'-'+curr.getMonth()+'-'+curr.getDate();
        if(calendarEvents[key]) {
          calendarEvents[key].forEach(ev => {
            var div = document.createElement('div'); div.className = 'm-event';
            div.style.borderLeftColor = ev.color;
            div.style.backgroundColor = ev.color + "15";
            div.textContent = ev.t; cell.appendChild(div);
          });
        }
        grid.appendChild(cell);
        curr.setDate(curr.getDate() + 1);
        if (curr.getDay() === 1 && curr > new Date(y, m + 1, 0)) break;
      }
      container.appendChild(grid);
    }

    function renderWeekView(container, today) {
      var start = new Date(viewDate); var day = start.getDay();
      start.setDate(start.getDate() - (day === 0 ? 6 : day - 1));
      document.getElementById('calendarLabel').textContent = "KW " + getKW(start);
      var wrap = document.createElement('div'); wrap.className = 'week-container';
      var side = document.createElement('div'); side.className = 'time-sidebar';
      for(var h=8; h<=22; h++) side.innerHTML += `<div class="hour-label">${h}:00</div>`;
      wrap.appendChild(side);
      var days = ['Mo','Di','Mi','Do','Fr','Sa','So'];
      for(var i=0; i<7; i++) {
        var c = new Date(start); c.setDate(start.getDate() + i);
        var col = document.createElement('div'); col.className = 'day-col';
        if(c.toDateString() === today.toDateString()) col.classList.add('today-bg');
        var k = c.getFullYear()+'-'+c.getMonth()+'-'+c.getDate();
        if(calendarEvents[k]) {
          calendarEvents[k].forEach(ev => {
            if(ev.h >= 8 && ev.h <= 22) {
              var card = document.createElement('div'); card.className = 'event-card';
              card.style.top = ((ev.h - 8) * 60 + ev.m) + 'px'; card.style.height = '50px';
              card.style.borderLeftColor = ev.color; card.style.backgroundColor = ev.color + "25";
              card.innerHTML = `<span style="color:${ev.color}; font-weight:bold;">${ev.time}</span> ${ev.t}`;
              col.appendChild(card);
            }
          });
        }
        wrap.appendChild(col);
      }
      container.appendChild(wrap);
    }

    function loadCal() {
      calendarEvents = {};
      Object.keys(fileColors).forEach(f => {
        fetch('calendars/' + f).then(r => r.text()).then(data => {
          var lines = data.split('\n');
          for(var i=0; i<lines.length; i++) {
            if(lines[i].includes('BEGIN:VEVENT')) {
              var ev = {h:8, m:0, time:'', color: fileColors[f]}, j = i;
              while(lines[j] && !lines[j].includes('END:VEVENT')){
                if(lines[j].includes('DTSTART')){
                  var v = lines[j].split(':')[1]?.trim();
                  if(v){
                    ev.d = new Date(v.substring(0,4), parseInt(v.substring(4,6))-1, parseInt(v.substring(6,8)));
                    if(v.includes('T')){
                      ev.h = parseInt(v.substring(9,11)); ev.m = parseInt(v.substring(11,13));
                      ev.time = ev.h + ":" + (ev.m < 10 ? '0' : '') + ev.m;
                    }
                  }
                }
                if(lines[j].includes('SUMMARY')) ev.t = lines[j].split(':')[1]?.replace(/\\/g,"").trim();
                j++;
              }
              if(ev.d){
                var k = ev.d.getFullYear()+'-'+ev.d.getMonth()+'-'+ev.d.getDate();
                if(!calendarEvents[k]) calendarEvents[k]=[]; calendarEvents[k].push(ev);
              }
              i = j;
            }
          }
          renderCalendar();
        }).catch(e => console.log(f + " nicht geladen"));
      });
    }

    document.getElementById('prevBtn').onclick = () => { if(currentView==='month') viewDate.setMonth(viewDate.getMonth()-1); else viewDate.setDate(viewDate.getDate()-7); renderCalendar(); };
    document.getElementById('nextBtn').onclick = () => { if(currentView==='month') viewDate.setMonth(viewDate.getMonth()+1); else viewDate.setDate(viewDate.getDate()+7); renderCalendar(); };
    document.getElementById('todayBtn').onclick = () => { viewDate = new Date(); renderCalendar(); };
    document.getElementById('viewMonth').onclick = function(){ currentView = 'month'; this.classList.add('active'); document.getElementById('viewWeek').classList.remove('active'); renderCalendar(); };
    document.getElementById('viewWeek').onclick = function(){ currentView = 'week'; this.classList.add('active'); document.getElementById('viewMonth').classList.remove('active'); renderCalendar(); };
    
    loadCal();
  </script>
</body>
</html>
